---
title: "Analysing Cookie Cats"
author: "Eduard Corral, Marcel Feliu and Paula Ros."
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Getting to know the datasets

Before we start with the analysis, have a look at the structure of both datasets. First, upload the data sets in
R. For a smoother correction on my side, please provide the data frames with the following names:
• For dataset ‘cookie_cats_ABtest.csv‘ use data frame variable named ‘DS‘.
• For dataset ‘cookie_cats_purch.csv", use data frame variable named ‘PR‘.
For each dataset, show and describe the information that they contain: rows and columns of the dataset, and
types of variables.

```{r Getting to know the datasets}
  DS <- read.csv("cookie_cats_ABtest.csv", sep = ",")
  PR <- read.csv("cookie_cats_purch.csv", sep = ",")
  
  str(DS)
  str(PR)
```

## 2. Preprocessing

Before we start with the analysis, revise the structure and contents of the data sets to look for inconsistencies,
missing values, or errors, and if necessary, perform the necessary transformations. You should also check that
all IDs of the second data set (cookie_cats_purch) are valid IDs (i.e., existing IDs in cookie_cats_ABtest).
If you apply any transformation, you should include a proper explanation in your report.

### 2.1. Preprocessing dataset “Cookie Cats AB Testing”

First of all, we used the function is.na() to locate the rows that had NA and then, we deleted them.

```{r Preprocessing part 1 Cookie Cats AB Testing}
  naUserid <- which(is.na(DS$userid)) ; naUserid
  DS <- DS[-naUserid, ]
```
After that, we used the function table() to look at the different variables to discover any more inconsistencies. We discovered that the variable called "retention_1" had two versions of TRUE and two versions of FALSE,
ones with lowercase letters and spaces and the others correct, with capital letters. The following code shows the process on preprocessing the content of this variable.

```{r Preprocessing part 2 Cookie Cats AB Testing}
  table(DS$retention_1)
  DS$retention_1[DS$retention_1 == "false "] = FALSE
  DS$retention_1[DS$retention_1 == "  true "] = TRUE
  table(DS$retention_1)
```
Finally, we deleted one value from the sum_gamerounds that was too big and had no consistence compared to the rest of the values.
```{r Preprocessing part 3 Cookie Cats AB Testing}
  DS <- DS[-which.max(DS$sum_gamerounds), ]
```
### 2.2. Preprocessing dataset “Cookie Cats Purchases”

For the "Cookie Cats Purchases" dataset we discovered that the NA from the previous dataset were included too in this one. We obtained the positions of this variables and deleted their rows.

```{r Preprocessing Cookie Cats Purchases}
  inexistentValues <- which((PR$id %in% DS$userid) == FALSE) ; inexistentValues
  PR <- PR[-inexistentValues, ]
  which((PR$id %in% DS$userid) == FALSE)
```
In addition, we deleted the NAs that were in the column purch.
```{r Preprocessing NAs from variable purch}
  naPurch <- which(is.na(PR$purch)) ; naPurch
  PR <- PR[-naPurch, ]
```
Moreover, we changed the column purch that was formed by characters to a numerical one, deleting the EUR.
```{r Preprocessing variable purch}
  PR['purch'] <-  as.numeric(gsub("[a-zA-Z]","", PR$purch))
```

Finally, we changed the negative values into positive because it didn't make sense to buy in negative.
```{r Changing negative values into positive}
  PR$purch[PR$purch < 0] <- -(PR$purch[PR$purch < 0])
  unique(PR$purch)
```



## 3. Descriptive Analytics

Perform descriptive analytics of the datasets visually and numerically. To make this task simpler, we’ll do
the analysis for each data set separately.

### 3.1. Dataset “Cookie Cats AB Testing”
#### 3.1.1 Users that downloaded the game
There are 90.186 users that downloaded the Cookie Cats game.
```{r Users that downloaded the games}
  nrow(DS)
```
#### 3.1.2 Distribution of users in groups
From the 90.186 users, 44699 played the gate number 30 and 45.487 played the gate number 40.
```{r Distribution of users in groups}
  table(DS$version)
```

#### 3.1.3 Game rounds
The next step was calculating the distribution of game rounds in the players’ population in a boxplot to show it in a visual way. We also calculated the distribution of game rounds among the users of version A (gate_30) and version B (gate_40) of the game separately and compared them.
```{r Game rounds}
  boxplot(DS$sum_gamerounds)
  groupA <- DS$sum_gamerounds[DS$version == "gate_30"]
  groupB <- DS$sum_gamerounds[DS$version == "gate_40"]
  boxplot(groupA, groupB, names = c("Group A", "Group B"))
```

#### 3.1.4 Retention (day 1 and day 7)
What is the value of retention at day 1? (percentage of users that are still active the day after
installation).
```{r retention day 1}
  activeUsersDay1 <- sum(DS$retention_1 == TRUE)
  totalUsers <- nrow(DS)
  percentageRetentionDay1 <- activeUsersDay1 * 100 / totalUsers
  paste(as.character(round(percentageRetentionDay1, 3)),"%")
```
What is the value of retention at day 7? (percentage of users that are still active after one week of
installation).
```{r retention day 7}
  activeUsersDay7 <- sum(DS$retention_1 == TRUE & DS$retention_7 == TRUE)
  percentageRetentionDay7 <- activeUsersDay7 * 100 / totalUsers
  paste(as.character(round(percentageRetentionDay7, 3)),"%")
```

#### 3.1.5 Are there non-playing users?
ESCRIBIR
```{r Sum non-playing users}
  non.playing.users <- sum(DS$retention_1 == FALSE & DS$retention_7 == FALSE) ; non.playing.users
```
KAKAKAK
```{r Percentage non-playing users}
  percentageNonPlayingUsers <- non.playing.users * 100 / totalUsers
  paste(as.character(round(percentageNonPlayingUsers, 2)),"%")
```

### 3.2 Dataset “Cookie Cats Purchases” (MARCEEEEEEEEEL :)
#### 3.2.1 Percentage of paying users

BLABLABLABLA
```{r Percentage of paying users}
  num.users.DS <- nrow(DS) ; num.users.DS
  num.users.PR <- nrow(PR) ; num.users.PR
  PR.AND.DS.USERS <- sum(num.users.DS, num.users.PR) ; PR.AND.DS.USERS
  
  percentage.paying.users <- num.users.PR * 100 / PR.AND.DS.USERS ; percentage.paying.users
  paste(as.character(round(percentage.paying.users, 2)), "%")
```
MORE BLA BLA BLA
```{r Percentage of people who has purchases more than 1 time}
  repeated <- length(table(PR$id))
  percentage.multiple.purchases <- repeated * 100 / num.users.PR
  paste(as.character(round(percentage.multiple.purchases, 2)), "%")
```

## 4. Monetization metrics (MARCEEEEEEEEEL :)

## 5. A/B testing (edu :)
### 5.1 Hypotheses
NULL: gate 40 doesn't improve the engagement of the users
ALTERNATIVE: gate 40 improves the engagement of the users
### 5.2 Visualisation
### 5.3 Computation
```{r Computation}
  #stdev <- sqrt(sum((dataset$A)^2) / (length(dataset$A)-1))
```

### 5.4 Conclusion of A/B testing

## 6. Regression analysis (paula :)
In this section, we aim at answering Researh Question 9: “Can the amount of in-app purchases be related to the number of game rounds of the players?” Thus, we would like to investigate whether the amount of in-app purchases depends somehow on the number
of game rounds. In order to answer this question, we will use the regression analysis.

### 6.0 Merge the datasets
First of all, we used the library dplyr in order to merge the two datasets. We decided to create two new datasets, one with all the population (merge.all) and another with just the users that did a purchase in the game (merge.purch), with the two datasets we will compare both models to know which has the best linear model. In the dataset with all the population we changed the NAs values from purch to 0 EUR.
```{r Merge datasets}
  library(dplyr)
  merge.all <-merge(DS,PR,by.x="userid",by.y="id", all = TRUE)
  merge.all$purch[is.na(merge.all$purch)] <- 0
  
  merge.purch = merge(DS,PR,by.x="userid",by.y="id")
```
### 6.1 Visual representation
Represent visually the potential relationship between the total amount spent by the user and the number of game rounds.
```{r Visual representation}
  plot(merge.all$sum_gamerounds, merge.all$purch, xlab = "Number of Game Rounds", ylab = "Amount spent by user in EUR", main = "Relationship between the game rounds and the purchases")
```

### 6.2 Building the model
Develop the model with linear regression analysis and visualise the model. Explain how the model relates the total amount of purchases with the game rounds.
```{r Building the model}
  lm.all <- lm(merge.all$purch ~ merge.all$sum_gamerounds, merge.all)
  lm.all

  
  lm.just.purch <- lm(merge.purch$purch ~ merge.purch$sum_gamerounds, merge.purch)
  lm.just.purch

```

### 6.3 Model fit
Evaluate the quality of the model. Is it an accurate model?
```{r Model fit}
  summary(lm.all)
  summary(lm.just.purch)
```

### 6.4 Predict a case
Predict how much a user would spend if he/she has been playing 50 game rounds.
```{r Predicting a case of 50 game rounds}

```

### 6.5 Simulation
Run a simulation of how much a player would spend for different game rounds, ranging from 0 until 1000,
every 50 rounds. Build a table and draw a plot.
```{r Simulation player spending for different game rounds}

```

## 7. Dashboard (quien acabe antes :)

## 8. Conclusion (todes :)

## 9. Team contribution (todes :)

## 10. Non-cheating manifesto (todes :)

